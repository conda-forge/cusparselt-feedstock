{% set version = "0.8.0.4" %}
{% set platform = "linux-x86_64" %}  # [linux64]
{% set platform = "linux-sbsa" %}  # [aarch64]
{% set platform = "windows-x86_64" %}  # [win]
{% set extension = "tar.xz" %}  # [not win]
{% set extension = "zip" %}  # [win]

package:
  name: cusparselt
  version: {{ version }}

source:
  url: https://developer.download.nvidia.com/compute/cusparselt/redist/libcusparse_lt/{{ platform }}/libcusparse_lt-{{ platform }}-{{ version }}_cuda12-archive.{{ extension }}  # [(cuda_compiler_version or "").startswith("12")]
  url: https://developer.download.nvidia.com/compute/cusparselt/redist/libcusparse_lt/{{ platform }}/libcusparse_lt-{{ platform }}-{{ version }}_cuda13-archive.{{ extension }}  # [(cuda_compiler_version or "").startswith("13")]
  sha256: b59e2f8ffd154b156b2d74ccd7cad7775385693bec8cb9562596060072c515f2  # [aarch64 and (cuda_compiler_version or "").startswith("12")]
  sha256: 483954591766bade877becef126d53908d5fef5d7468b503736af37388669c08  # [linux64 and (cuda_compiler_version or "").startswith("12")]
  sha256: d2010d798336eb2df63bf54c5379e8f2f83f72fa21b4f1bf5c1168b541ae9599  # [win and (cuda_compiler_version or "").startswith("12")]
  sha256: 0a70952a00139e8cc60db282a041f4003febf1529f467ee997dc80770dd1faa1  # [linux64 and (cuda_compiler_version or "").startswith("13")]
  sha256: 849824258db33d850fb68be7d65e7e98375e98dfcbbda93275d124a0ea590dfe  # [aarch64 and (cuda_compiler_version or "").startswith("13")]
  sha256: 0fa0f02d95b3b00e7c48315d59452d71dffdc8e07a50936faf02cb5b7179c1ca  # [win and (cuda_compiler_version or "").startswith("13")]


  sha256: 21fad1b3a8a3db018868184b2082bd492633ae5101752432d655782bd108b19e  # [linux64 and (cuda_compiler_version or "").startswith("12")]
  sha256: ce92b4058d95c85959b822baa56389126a31678f5068b486523d1aa7f6490fcb  # [linux64 and (cuda_compiler_version or "").startswith("13")]
  sha256: af8c670f221bd0837c27452c1a88d31384b459e9dd0947818a06fbafdbef7f69  # [aarch64 and (cuda_compiler_version or "").startswith("12")]
  sha256: 27d9e9c70a5f464ddbacd4fdd433f4e736d6f4b32387c111d77d33b583c46f26  # [aarch64 and (cuda_compiler_version or "").startswith("13")]
  sha256: 47e83e940946a13d9707cbdde6886b8750110185354e8a3d9b5e9de52e4bec2e  # [win and (cuda_compiler_version or "").startswith("12")]
  sha256: 331393e15bb5efd0f4918e99cdd4f098d9e5fc534c58c10f8675b6967bbdc524  # [win and (cuda_compiler_version or "").startswith("13")]

build:
  number: 0
  skip: true  # [ppc64le or not (cuda_compiler_version or "").startswith("12", "13")]
  script:
    - check-glibc lib/*.so.*                                                  # [unix]
    - mkdir -p $PREFIX/include                                                # [unix]
    - cp -r include/* $PREFIX/include/                                        # [unix]
    - mkdir -p $PREFIX/lib                                                    # [unix]
    - mv lib/libcusparseLt.so* $PREFIX/lib/                                   # [unix]

    - copy include\\cusparseLt.h %LIBRARY_INC%\\                           # [win64]
    - copy lib\\cusparseLt.dll %LIBRARY_BIN%\\                             # [win64]
    - copy lib\\cusparseLt.lib %LIBRARY_LIB%\\                             # [win64]
  run_exports:
    - {{ pin_subpackage('cusparselt', max_pin='x.x.x.x') }}
  missing_dso_whitelist:
    - '*/libgomp.*'  # [linux]

requirements:
  build:
    - arm-variant * {{ arm_variant_type }}  # [aarch64]
    - {{ compiler('c') }}
    - {{ stdlib("c") }}
    - {{ compiler('cxx') }}
    - {{ compiler('cuda') }}
    - cf-nvidia-tools 1   # [linux]
      # https://github.com/NixOS/patchelf/issues/492
    - patchelf <0.18.0    # [linux]
  run:

test:
  requires:
    - git
    - {{ stdlib('c') }}
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ compiler('cuda') }}
    # tests need the cuSPARSE header & libnvrtc.so
    - libcusparse-dev
    - cuda-nvrtc-dev
    - cuda-driver-dev        # [linux and (cuda_compiler_version or "").startswith("12", "13")]
    - patchelf               # [linux]
  files:
    - test_load_elf.c        # [linux]

about:
  home: https://developer.nvidia.com/cusparse
  license: LicenseRef-cuSPARSELt-Software-License-Agreement
  license_url: https://docs.nvidia.com/cuda/cusparselt/license.html
  license_file: LICENSE
  summary: "Basic Linear Algebra for Sparse Matrices on NVIDIA GPUs"
  description: |
    NVIDIA cuSPARSELt is a high-performance CUDA library dedicated to general
    matrix-matrix operations in which at least one operand is a structured sparse matrix with 50\% sparsity.
    The cuSPARSELt APIs allow flexibility in the algorithm/operation selection,
    epilogue, and matrix characteristics, including memory layout,
    alignment, and data types.
    License Agreements:- The packages are governed by the NVIDIA cuSPARSELt
    Software License Agreement (EULA). By downloading and using the packages,
    you accept the terms and conditions of the NVIDIA cuSPARSELt EULA -
    https://docs.nvidia.com/cuda/cusparselt/license.html
  doc_url: https://docs.nvidia.com/cuda/cusparselt/index.html
  dev_url: https://developer.nvidia.com/cusparselt/downloads

extra:
  recipe-maintainers:
    - kvoronin
    - mtjrider
    - mnicely
    - leofang
